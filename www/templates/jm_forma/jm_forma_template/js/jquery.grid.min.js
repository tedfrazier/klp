!(function($){
  $.fn.JMGrid=function(k){
    var l={
      filter:'',
      sort:'',
      ordering:'asc',
      data_sort:'name',
      cols:3,
      margin:10,
      item:'.item',
      hiddenClass:'jmhidden',
			itemWidth:null,
			itemHeight:null,
			itemTitleHeight:0,
			marginBottom:null,
			OnFilter: function(){}
    };
    var m=$.extend(l,k);
    m.width=$(this).width();
    m.colstmpl=m.cols;
		if(m.marginBottom==null) m.marginBottom = m.margin;
    this.each(function(){
      var b=$(this);
      var c=b.find(m.item);
      m.rate=m.itemWidth/m.itemHeight;
      gridFilter(b);
			$(m.filter).click(function(){
        var a=$(this).attr('data-filter');
        if($(this).index()!=0){
          $(this).parent().find('.current').not(this).removeClass('current');
          $(this).addClass('current')
        }
        if(a!=null){
          c.removeClass(m.hiddenClass).not(a).addClass(m.hiddenClass)
        }
        gridFilter(b);
      });
      $(m.sort).click(function(){
        if($(this).index()!=0){
          $(this).parent().find('.current').not(this).removeClass('current');
          $(this).addClass('current')
        }
        var a=$(this).attr('data-sorting');
        if(a){
          m.data_sort=a;
          gridSort(b)
        }
      });
      var f=false;
      var g=setInterval(function(){
        f=true
        },500);
      $(window).resize(function(e){
        if(true){
          gridFilter(b);
          f=false
        }
      })
    });
    function gridFilter(a){
      var b=null;
      if(m.hiddenClass!=null){
        b=a.find(m.item).not("."+m.hiddenClass)
      }else{
        b=a.find(m.item)
      }
      animateItems(a,b);
			m.OnFilter.call(this);
    }
    function gridSort(a){
      var b=null;
      if(m.hiddenClass!=null){
        b=a.find(m.item).not("."+m.hiddenClass)
      }else{
        b=a.find(m.item)
      }
      b.sort(compare);
      animateItems(a,b)
    }
    function compare(a,b){
      if(m.data_sort=='name'){
        var c=$(a).find('.jmvideogalleries_title').text();
        var d=$(b).find('.jmvideogalleries_title').text()
      }else if(m.data_sort=='date'){
        var c=$(a).find('.jmvideogalleries_date').text();
        var d=$(b).find('.jmvideogalleries_date').text()
      }
      if(m.ordering=='asc'){
        if(c<d)return-1;
        if(c>d)return 1
      }else{
        if(c>d)return-1;
        if(c<d)return 1
      }
      return 0
    }
    function animateItems(f,g){
      if($(window).width()<760){
        m.cols=1
      }else{
        m.cols=m.colstmpl
      }
      var width=(f.width()-m.margin*(m.cols-1))/m.cols;
			var height = width*m.itemHeight/m.itemWidth;
			//alert(height);
			g.css({
        position:'absolute'
      });
      var rows=Math.ceil(g.length/m.cols);
      var wrapHeight=height*rows+(rows-1)*m.marginBottom;
      f.height(wrapHeight);
			$(g).each(function(a){
        var b=(a%m.cols);
        var c=Math.floor((a)/m.cols);
        var d=c*width/m.rate+c*m.marginBottom;// + m.itemTitleHeight;
        var e=b*width+(b)*m.margin;
        $(this).css({
          width:width,
					height: height,
          top:d,
          left:e
        })
      })
    }
  }
})(jQuery);